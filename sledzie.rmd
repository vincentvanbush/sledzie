---
title: "Predykcja wymiarów śledzi"
author: "Michał Buszkiewicz"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

## Streszczenie raportu

bla bla bla

## Zastosowane biblioteki, czynności wstępne
Wczytanie bibliotek `dplyr` (przetwarzanie danych), `ggplot2` i `plotly` (prezentacja graficzna) i `easyGgplot2` (rozszerzenia do `ggplot2`) i ustawienie ziarna generatora liczb losowych.
```{r setup, results='hide', message=FALSE}
library(dplyr)
library(plotly) # devtools::install_github(“ropensci/plotly”)
library(ggplot2)
library(easyGgplot2) # devtools::install_github("kassambara/easyGgplot2")
library(reshape2)
set.seed(23)
```
## Wczytanie i wstępnie przetworzenie danych

```{r read_data, cache=TRUE}
raw.data <- read.csv('sledzie.csv', na.strings = '?')
```

Dane zawierają sporadycznie występujące puste wartości, które zostaną wypełnione medianami występującymi dla odpowiednich wartości kolumn `xmonth` i `recr`, które nie zawierają wartości pustych. Uznano to rozwiązanie za akceptowalne dla celów tej pracy, ponieważ liczności zbiorów wartości poszczególnych kolumn są niewielkie (w granicach 50 unikalnych wartości) w porównaniu z liczbą wierszów całej tabeli (ponad 50 tysięcy). Brakujące wartości są na tyle nieliczne, że wpływ ewentualnych przekłamań na wynik pracy można traktować jako pomijalny.

```{r fill_gaps, cache=TRUE}
processed.data <-
  raw.data %>%
    rowwise() %>%
    mutate_all(
      funs(
        replace(., is.na(.), (
            function(rownum, v, ref_recr, ref_xmonth) {
              if (!is.na(v)) {
                return(v);
              }
              else {
                filtered = raw.data %>% filter(recr == ref_recr, xmonth == ref_xmonth)
                med = (filtered %>% summarize(median(., na.rm = TRUE)))[[1]]
                return(med)
              }
            }
          ) (X, ., recr, xmonth)
        )
      )
    )
```

## Podstawowe podsumowanie danych

Zbiór zawiera `r count(processed.data)` rekordów. Poniższa tabelka zawiera podstawowe statystyki dotyczące zbioru danych uzupełnionego o brakujące wartości komórek.

```{r raw_data_summary}
knitr::kable(summary(processed.data[, 1:8])); knitr::kable(summary(processed.data[, 9:16]))
```

## Rozkłady wartości zmiennych

Wartości średnie oznaczone liniami przerywanymi w kolorze czerwonym.

```{r distributions, cache=TRUE, fig.height=10, out.width="100%"}
plot.var <- function(varname, ...) {
  ggplot(processed.data, aes(x=get(varname))) +
    geom_histogram(color="black", fill="white", ...) +
    geom_vline(aes(xintercept=mean(get(varname))), color="red", linetype="dashed", size=1) +
    xlab(varname)
}

ggplot2.multiplot(
  plot.var("length", binwidth = 0.5), plot.var("cfin1", bins = 30), plot.var("cfin2", bins = 15),
  plot.var("chel1", bins = 30), plot.var("chel2", bins = 30), plot.var("lcop1", bins = 30),
  plot.var("lcop2", bins = 30), plot.var("fbar", binwidth = 0.08), plot.var("recr", bins = 15),
  plot.var("cumf", bins = 9), plot.var("totaln", bins = 12), plot.var("sst", binwidth = 0.15),
  plot.var("sal", binwidth = 0.012), plot.var("nao", binwidth = 1),# plot.var("xmonth", binwidth = 1),
  cols = 3
)
```

## Korelacja zmiennych

```{r correlation, out.width="100%"}
cor_matrix = round(cor(processed.data), 2)
#cor_matrix[lower.tri(cor_matrix)] <- NA
melted_cor_matrix <- melt(cor_matrix, na.rm = TRUE)

ggplot(data = melted_cor_matrix, aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "#91bfdb", high = "#fc8d59", mid = "#ffffbf", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Korelacja\nPearsona") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
        size = 12, hjust = 1)) +
  coord_fixed()
```
Mapa korelacji pozwala na wyciągnięcie pewnych wstępnych wniosków dotyczących przydatności poszczególnych zmiennych do budowy regresora przewidującego długość łowionych ryb (atrybut `length`).

* Zmienną `xmonth` możemy w rzeczywistości uznać za atrybut nominalny i sama w sobie nie niesie ona żadnych informacji mogących pomóc w predykcji - jest to atrybut wtórny, będący jedynie niepełną częścią informacji o chronologii.
* Pary zmiennych: `lcop1` i `chel1`, `lcop2` i `chel2` oraz `cumf` i `fbar` wykazują silną współliniowość. Rozsądne jest pozostawienie tylko po jednym atrybucie z każdej z tych par, ponieważ w przeciwnym razie zaburzone mogłyby być dane o istotności poszczególnych cech.
* Najsilniej skorelowane z atrybutem `length` oznaczającym długość złowionej ryby są atrybuty:
    + `sst` - temperatura przy powierzchni wody (korelacja `r round(cor(processed.data$length, processed.data$sst), 2)`) 
    + `nao` - oscylacja północnoatlantycka (korelacja `r round(cor(processed.data$length, processed.data$nao), 2)`)
* Atrybuty `sst` i `nao` posiadają przy tym wyraźną dodatnią korelację z atrybutem `X`, co zgodnie z założeniem o zachowaniu przez dane wejściowe chronologii mogłoby sugerować, że potencjalnie znaleziony regresor może uznać te zmienne za istotne czynniki predykcji.

## Ilustracja zmienności długości łowionych ryb

Poniższy wykres przedstawia zależność długości ryby (mierzonej z dokładnością ) od czasu (numeru sekwencyjnego próbki w zbiorze). Dodatkowo, próbki zostały pokolorowane w zależności od `sst` (temperatury przy powierzchni wody) - jaśniejszy odcień koloru niebieskiego oznacza wyższą temperaturę, a u dołu wykresu znajduje sie pasek pozwalający na przełączanie pomiędzy próbkami w momentach, gdy oscylacja północnoatlantycka (atrybut `nao`) osiągał wartości dodatnie, a tymi wykonanymi przy ujemnej wartości tej zmiennej (`nao_range` odpowiednio 1 i -1).

Na wykresie ze względu na wydajność nakreslono co `r freq=35; freq` rekord ze zbioru.
```{r length_diagram, out.width="100%", fig.height=5, warning=FALSE}
ggplotly(
  ggplot(processed.data[seq(1, nrow(processed.data), freq), ] %>% mutate(nao_range = sign(nao)), aes(X, length)) +
    geom_point(aes(color=sst, frame=nao_range)) +
    labs(x = "numer sekwencyjny próbki",
         y = "długość ryby (cm)",
         color = "Temp. pow.\nwody (st. C)",
         title = "Długość ryby, czas i temperatura")
)
```
Wizualizacja zdaje się być kolejnym czynnikiem mogącym potwierdzać przypuszczenie o związku temperatury przy powierzchni wody z długością łowionych ryb. W początkowym okresie badania (około 17000 próbek) wartość temperatury wykazywała tendencję spadkową (zilustrowane ciemniejącym odcieniem błękitu punktów), rosły zaś wskazania pomiaru długości ryb. W dalszej części wykresu temperatura przy powierzchni wody rośnie, spadają zaś pomiary długości śledzi.

Trudniejszy do oszacowania wydaje się być wpływ parametru oscylacji północnoatlantyckiej. Jest to zjawisko cykliczne, która to cykliczność polega na okresowej dominacji odczytów dodatnich lub ujemnych - co zresztą znajduje potwierdzenie w wykresie, jeśli spojrzeć na okresowe zagęszczenie próbek dla ujemnego i dodatniego `nao`. Atrybut ten jest też w dość dużym stopniu skorelowany z `sst` - w okresie dominacji ujemnych odczytów `nao` dominują też niższe wartości `sst` i większe długości łowionych śledzi.